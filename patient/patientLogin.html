<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Arvo:wght@700&family=Aileron&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Aileron', sans-serif;
      text-align: center;
      padding: 50px;
      background-color: #e6f2ff; 
    }
    h1 {
      font-family: 'Arvo', serif;
      font-size: 2em;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .confirmation h1 {
      margin-top: 0;
    }
    form {
      margin: 20px auto;
      max-width: 400px;
      text-align: left;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .button {
      padding: 10px 20px;
      background-color: #003366; 
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 10px auto;
      display: block;
    }
    .button:hover {
      background-color: #002244; 
    }
    .confirmation {
      display: none;
    }
    .error {
      color: #d32f2f;
      font-size: 0.875em;
      margin-top: -10px;
      margin-bottom: 10px;
      display: block;
    }
    .field-error {
      border-color: #d32f2f !important;
      background-color: #ffebee;
    }
    .success {
      color: #388e3c;
      font-size: 0.875em;
    }
    .validation-summary {
      background-color: #ffebee;
      border: 1px solid #d32f2f;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
      display: none;
    }
    .validation-summary.success {
      background-color: #e8f5e8;
      border-color: #388e3c;
      color: #388e3c;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>
  <div id="pageHeader">
    <h1>Patient Registration</h1>
    <p style="margin: 20px 0;">- OR -</p>
      <button type="button" class="button" onclick="showLoginForm()">Existing Patient Login</button>
  </div>
  <form id="registrationForm" onsubmit="return handleRegistration(event)">
    <div id="validationSummary" class="validation-summary"></div>
    
    <label for="firstName">First Name:</label>
    <input type="text" id="firstName" required minlength="2" maxlength="50" 
           pattern="[A-Za-z\s]+" title="First name should only contain letters and spaces">
    <span id="firstNameError" class="error"></span>

    <label for="lastName">Last Name:</label>
    <input type="text" id="lastName" required minlength="2" maxlength="50" 
           pattern="[A-Za-z\s]+" title="Last name should only contain letters and spaces">
    <span id="lastNameError" class="error"></span>

    <label for="dob">Date of Birth:</label>
    <input type="date" id="dob" required>
    <span id="dobError" class="error"></span>

    <label for="gender">Gender:</label>
    <select id="gender" required>
      <option value="">Select Gender</option>
      <option value="F">Female</option>
      <option value="M">Male</option>
    </select>
    <span id="genderError" class="error"></span>

    <label for="address">Address:</label>
    <input type="text" id="address" required minlength="10" maxlength="200" 
           title="Please provide a complete address">
    <span id="addressError" class="error"></span>

    <label for="phone">Phone:</label>
    <input type="tel" id="phone" required pattern="[\d\s\-\(\)\+]+" 
           placeholder="(123) 456-7890" title="Please enter a valid phone number">
    <span id="phoneError" class="error"></span>

    <label for="email">Email:</label>
    <input type="email" id="email" required maxlength="100" 
           title="Please enter a valid email address">
    <span id="emailError" class="error"></span>

    <label for="insuranceName">Insurance Name:</label>
    <input type="text" id="insuranceName" required minlength="2" maxlength="100" 
           title="Please enter your insurance provider name">
    <span id="insuranceNameError" class="error"></span>

    <label for="insuranceId">Insurance ID:</label>
    <input type="text" id="insuranceId" required minlength="5" maxlength="50" 
           pattern="[A-Za-z0-9\-]+" title="Insurance ID should contain only letters, numbers, and hyphens">
    <span id="insuranceIdError" class="error"></span>

    <div style="text-align: center;">
      <button type="submit" class="button">Register</button>
    </div>
  </form>

  <div class="confirmation" id="confirmation">
    <h1>Registration Successful</h1>
    <p>Your Patient ID: <span id="patientId"></span></p>
    <button class="button" onclick="showLoginForm()">Existing Patient Login</button>
  </div>

  <div class="login" id="loginForm" style="display:none;">
    <h1>Existing Patient Login</h1>
    <form onsubmit="return handleLogin(event)">
      <div id="loginValidationSummary" class="validation-summary"></div>
      
      <label for="loginFirstName">First Name:</label>
      <input type="text" id="loginFirstName" required minlength="2" maxlength="50" 
             pattern="[A-Za-z\s]+" title="First name should only contain letters and spaces">
      <span id="loginFirstNameError" class="error"></span>

      <label for="loginLastName">Last Name:</label>
      <input type="text" id="loginLastName" required minlength="2" maxlength="50" 
             pattern="[A-Za-z\s]+" title="Last name should only contain letters and spaces">
      <span id="loginLastNameError" class="error"></span>

      <label for="loginPatientId">Patient ID:</label>
      <input type="text" id="loginPatientId" required pattern="[0-9]+" 
             title="Patient ID should only contain numbers">
      <span id="loginPatientIdError" class="error"></span>

      <label for="loginDob">Date of Birth:</label>
      <input type="date" id="loginDob" required>
      <span id="loginDobError" class="error"></span>

      <div style="text-align: center;">
        <button type="submit" class="button">Login</button>
      </div>
    </form>
  </div>

  <script>
     fetch('../components/header.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('header-placeholder').innerHTML = data;
    });
    
    let patientIdCounter = 1; // Simulating a Patient ID counter

    // Validation functions
    function validateName(name, fieldName) {
      if (!name.trim()) {
        return `${fieldName} is required`;
      }
      if (name.length < 2) {
        return `${fieldName} must be at least 2 characters long`;
      }
      if (name.length > 50) {
        return `${fieldName} must be less than 50 characters`;
      }
      if (!/^[A-Za-z\s]+$/.test(name)) {
        return `${fieldName} should only contain letters and spaces`;
      }
      return null;
    }

    function validateEmail(email) {
      if (!email.trim()) {
        return 'Email is required';
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        return 'Please enter a valid email address';
      }
      return null;
    }

    function validatePhone(phone) {
      if (!phone.trim()) {
        return 'Phone number is required';
      }
      const phoneRegex = /^[\+]?[\d\s\-\(\)]+$/;
      if (!phoneRegex.test(phone)) {
        return 'Please enter a valid phone number';
      }
      const digitsOnly = phone.replace(/\D/g, '');
      if (digitsOnly.length < 10) {
        return 'Phone number must have at least 10 digits';
      }
      return null;
    }

    function validateDate(date, fieldName) {
      if (!date) {
        return `${fieldName} is required`;
      }
      const inputDate = new Date(date);
      const today = new Date();
      const maxAge = new Date(today.getFullYear() - 120, today.getMonth(), today.getDate());
      
      if (fieldName === 'Date of Birth') {
        if (inputDate >= today) {
          return 'Date of birth must be in the past';
        }
        if (inputDate < maxAge) {
          return 'Please enter a valid date of birth';
        }
      }
      return null;
    }

    function validateInsuranceId(insuranceId) {
      if (!insuranceId.trim()) {
        return 'Insurance ID is required';
      }
      if (insuranceId.length < 5) {
        return 'Insurance ID must be at least 5 characters long';
      }
      if (!/^[A-Za-z0-9\-]+$/.test(insuranceId)) {
        return 'Insurance ID should only contain letters, numbers, and hyphens';
      }
      return null;
    }

    function validatePatientId(patientId) {
      if (!patientId.trim()) {
        return 'Patient ID is required';
      }
      if (!/^\d+$/.test(patientId)) {
        return 'Patient ID should only contain numbers';
      }
      return null;
    }

    function showError(fieldId, errorId, message) {
      const field = document.getElementById(fieldId);
      const errorElement = document.getElementById(errorId);
      
      if (message) {
        field.classList.add('field-error');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      } else {
        field.classList.remove('field-error');
        errorElement.textContent = '';
        errorElement.style.display = 'none';
      }
    }

    function showValidationSummary(summaryId, errors, isSuccess = false) {
      const summary = document.getElementById(summaryId);
      
      if (errors.length > 0) {
        summary.innerHTML = '<strong>Please fix the following errors:</strong><br>' + errors.join('<br>');
        summary.className = 'validation-summary';
        summary.style.display = 'block';
      } else if (isSuccess) {
        summary.innerHTML = '<strong>All fields are valid!</strong>';
        summary.className = 'validation-summary success';
        summary.style.display = 'block';
      } else {
        summary.style.display = 'none';
      }
    }

    function handleRegistration(event) {
      event.preventDefault();
      
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const dob = document.getElementById('dob').value;
      const gender = document.getElementById('gender').value;
      const address = document.getElementById('address').value.trim();
      const phone = document.getElementById('phone').value;
      const email = document.getElementById('email').value;
      const insuranceName = document.getElementById('insuranceName').value.trim();
      const insuranceId = document.getElementById('insuranceId').value;

      let errors = [];

      // Validate all fields
      const firstNameError = validateName(firstName, 'First name');
      const lastNameError = validateName(lastName, 'Last name');
      const dobError = validateDate(dob, 'Date of Birth');
      const phoneError = validatePhone(phone);
      const emailError = validateEmail(email);
      const insuranceIdError = validateInsuranceId(insuranceId);

      // Show individual field errors
      showError('firstName', 'firstNameError', firstNameError);
      showError('lastName', 'lastNameError', lastNameError);
      showError('dob', 'dobError', dobError);
      showError('phone', 'phoneError', phoneError);
      showError('email', 'emailError', emailError);
      showError('insuranceId', 'insuranceIdError', insuranceIdError);

      // Gender validation
      if (!gender) {
        showError('gender', 'genderError', 'Please select a gender');
        errors.push('Gender is required');
      } else {
        showError('gender', 'genderError', null);
      }

      // Address validation
      if (!address || address.length < 10) {
        showError('address', 'addressError', 'Address must be at least 10 characters long');
        errors.push('Valid address is required');
      } else {
        showError('address', 'addressError', null);
      }

      // Insurance name validation
      if (!insuranceName || insuranceName.length < 2) {
        showError('insuranceName', 'insuranceNameError', 'Insurance name is required');
        errors.push('Insurance name is required');
      } else {
        showError('insuranceName', 'insuranceNameError', null);
      }

      // Collect all errors
      if (firstNameError) errors.push(firstNameError);
      if (lastNameError) errors.push(lastNameError);
      if (dobError) errors.push(dobError);
      if (phoneError) errors.push(phoneError);
      if (emailError) errors.push(emailError);
      if (insuranceIdError) errors.push(insuranceIdError);

      showValidationSummary('validationSummary', errors, errors.length === 0);

     if (errors.length === 0) {
  const payload = {
    FirstName: firstName.trim(),
    LastName: lastName.trim(),
    DOB: dob || null,
    Gender: gender,
    Address: address.trim(),
    Phone: phone.trim(),
    Email: email.trim(),
    InsuranceName: insuranceName.trim(),
    InsuranceID: insuranceId.trim()
  };

  fetch('../backend/api/patients-create.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) {
      showValidationSummary('validationSummary', [data.error || 'Registration failed']);
      return;
    }
    // Show PatientID from DB
    document.getElementById('patientId').innerText = data.PatientID;
    document.getElementById('registrationForm').style.display = 'none';
    document.getElementById('pageHeader').style.display = 'none';
    document.getElementById('confirmation').style.display = 'block';
  })
  .catch(err => {
    console.error(err);
    showValidationSummary('validationSummary', ['Network/server error']);
  });
}

      return false;
    }

    function handleLogin(event) {
      event.preventDefault();
      
      const firstName = document.getElementById('loginFirstName').value;
      const lastName = document.getElementById('loginLastName').value;
      const patientId = document.getElementById('loginPatientId').value;
      const dob = document.getElementById('loginDob').value;

      let errors = [];

      // Validate all fields
      const firstNameError = validateName(firstName, 'First name');
      const lastNameError = validateName(lastName, 'Last name');
      const patientIdError = validatePatientId(patientId);
      const dobError = validateDate(dob, 'Date of Birth');

      // Show individual field errors
      showError('loginFirstName', 'loginFirstNameError', firstNameError);
      showError('loginLastName', 'loginLastNameError', lastNameError);
      showError('loginPatientId', 'loginPatientIdError', patientIdError);
      showError('loginDob', 'loginDobError', dobError);

      // Collect all errors
      if (firstNameError) errors.push(firstNameError);
      if (lastNameError) errors.push(lastNameError);
      if (patientIdError) errors.push(patientIdError);
      if (dobError) errors.push(dobError);

      showValidationSummary('loginValidationSummary', errors, errors.length === 0);

     if (errors.length === 0) {
  const payload = {
    firstName: firstName.trim(),
    lastName: lastName.trim(),
    PatientID: parseInt(patientId, 10),
    DOB: dob
  };

  fetch('../backend/api/patient-login.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
  if (!data.success) {
    showValidationSummary('loginValidationSummary', [data.error || data.message || 'Login failed']);
    return;
  }

  // ✅ Save logged-in patient for other pages (like addAppointment)
  localStorage.setItem('patientId', String(data.patient.PatientID));
  localStorage.setItem('patientFirstName', data.patient.FirstName || '');
  localStorage.setItem('patientLastName',  data.patient.LastName  || '');

  // Optional: quick sanity log
  console.log('Saved patientId:', localStorage.getItem('patientId'));

  window.location.href = 'patientDashboard.html';
})

  .catch(err => {
    console.error(err);
    showValidationSummary('loginValidationSummary', ['Network/server error']);
  });
}


      return false;
    }

    function showLoginForm() {
      document.getElementById('registrationForm').style.display = 'none';
      document.getElementById('confirmation').style.display = 'none';
      document.getElementById('pageHeader').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }

    // Real-time validation
    document.addEventListener('DOMContentLoaded', function() {
      const fields = ['firstName', 'lastName', 'phone', 'email', 'insuranceId'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.addEventListener('blur', function() {
          let error = null;
          switch(fieldId) {
            case 'firstName':
            case 'lastName':
              error = validateName(this.value, fieldId === 'firstName' ? 'First name' : 'Last name');
              break;
            case 'phone':
              error = validatePhone(this.value);
              break;
            case 'email':
              error = validateEmail(this.value);
              break;
            case 'insuranceId':
              error = validateInsuranceId(this.value);
              break;
          }
          showError(fieldId, fieldId + 'Error', error);
        });
      });

      // Login form real-time validation
      const loginFields = ['loginFirstName', 'loginLastName', 'loginPatientId'];
      loginFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('blur', function() {
            let error = null;
            switch(fieldId) {
              case 'loginFirstName':
              case 'loginLastName':
                error = validateName(this.value, fieldId === 'loginFirstName' ? 'First name' : 'Last name');
                break;
              case 'loginPatientId':
                error = validatePatientId(this.value);
                break;
            }
            showError(fieldId, fieldId + 'Error', error);
          });
        }
      });
    });
  </script>
</body>
</html>
